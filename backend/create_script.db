PRAGMA foreign_keys = ON;

DROP TABLE IF EXISTS person_quest;
DROP TABLE IF EXISTS person_item;
DROP TABLE IF EXISTS person_limb;

DROP TABLE IF EXISTS limb;

DROP TABLE IF EXISTS quest;
DROP TABLE IF EXISTS item;

DROP TABLE IF EXISTS person;

CREATE TABLE person ( 
	personid INTEGER PRIMARY KEY AUTOINCREMENT, 
	name TEXT, 
	hp INTEGER,
	maxhp INTEGER,
	admin INTEGER CHECK (admin IN (0, 1)) DEFAULT 0
); 

CREATE TABLE limb(
	limbid 		INTEGER PRIMARY KEY AUTOINCREMENT, 
	name		TEXT
);

CREATE TABLE quest (
	questid		INTEGER PRIMARY KEY AUTOINCREMENT, 
	name 		TEXT, 
	description	TEXT,
	status		TEXT CHECK (status IN ('incomplete','success','failure')) DEFAULT 'incomplete',
	UNIQUE(name)
);

CREATE TABLE item (
	itemid		INTEGER PRIMARY KEY AUTOINCREMENT,
	name		TEXT,
	description	TEXT,
	UNIQUE(name)
);

CREATE TABLE person_quest( 
	personquestid	INTEGER PRIMARY KEY AUTOINCREMENT, 
	questassignee	INTEGER, 
	assignedquest	INTEGER, 
	FOREIGN KEY (questassignee) REFERENCES person(personid), 
	CONSTRAINT fk_quests
		FOREIGN KEY (assignedquest) 
		REFERENCES quest(questid)
		ON DELETE CASCADE
);

CREATE TABLE person_item(
	quantity	INTEGER,
	itemowner 	INTEGER,
	owneditem	INTEGER,
  	PRIMARY KEY (itemowner, owneditem),
	FOREIGN KEY (itemowner) REFERENCES person(personid),
	CONSTRAINT fk_items
		FOREIGN KEY (owneditem) 
		REFERENCES item(itemid)
		ON DELETE CASCADE

);

CREATE TABLE person_limb( 
	personlimbid	INTEGER PRIMARY KEY AUTOINCREMENT,
	status 			INTEGER DEFAULT 0, 
	limbowner 		INTEGER, 
	limbtype		INTEGER,
	FOREIGN KEY (limbtype) REFERENCES limb(limbid)
	CONSTRAINT fk_person
		FOREIGN KEY (limbowner) 
		REFERENCES person(personid)
		ON DELETE CASCADE
);

/*
	Creates all available people at once
*/
INSERT INTO person (name,hp,maxhp) VALUES ('test', 85, 85);
INSERT INTO person (name,hp,maxhp) VALUES ('other', 55, 55);
INSERT INTO person (name,hp,maxhp,admin) VALUES ('cam', 90, 90, 1);
INSERT INTO person (name,hp,maxhp) VALUES ('up', 90, 90);

/*
	Creates all available types of limbs
*/
INSERT INTO limb (name) VALUES ('head');
INSERT INTO limb (name) VALUES ('leftarm');
INSERT INTO limb (name) VALUES ('rightarm');
INSERT INTO limb (name) VALUES ('torso');
INSERT INTO limb (name) VALUES ('leftleg');
INSERT INTO limb (name) VALUES ('rightleg');

/* 
	Creates a new version of the limb for each existing person
*/
INSERT INTO person_limb (limbowner,limbtype)
SELECT  person.personid AS limbowner,
        limb.limbid AS limbtype
FROM person CROSS JOIN limb;

INSERT INTO quest (name, description) VALUES ('quest one', 'I am quest description one');
INSERT INTO quest (name, description) VALUES ('quest two', 'I am quest description two');
INSERT INTO quest (name, description) VALUES ('quest three', 'I am  questdescription three');

INSERT INTO item (name, description) VALUES ('item one', 'I am item description one');
INSERT INTO item (name, description) VALUES ('item two', 'I am item description two');
INSERT INTO item (name, description) VALUES ('item three', 'I am item description three');
